---
- hosts: local
  name: bootstrap
  become: yes
  become_user: root
  tasks:
  - name: Create group
    group:
      name: hydro
      state: present
  - name: Create user
    user:
      name: hydro
      state: present
      shell: /bin/bash
      groups: hydro,sudo

  - name: Install packages
    ansible.builtin.apt:
      pkg:
      - git
      - python3-pip
      - zip
      - socat

  - name: Install python packages
    ansible.builtin.pip:
      name:
        - awsiotsdk
  - name: Copy command line utils package
    copy:
      src: command-line-utils
      dest: /home/hydro/
      owner: hydro
      group: hydro
  - name: Copy command line utils package
    ansible.builtin.shell: pip install -e /home/hydro/command-line-utils
      args:
        executable: /bin/bash
  - name: Copy webhook receiver service
    copy:
      src: github-webhook-receiver-service
      dest: /home/hydro/
      owner: hydro
      group: hydro
  - name: Copy ansible config
    copy:
      src: hydro-ansible.cfg
      dest: /home/hydro/.ansible.cfg
      owner: hydro
      group: hydro
  - name: Download AWS root certificate
    ansible.builtin.get_url:
      url: https://www.amazontrust.com/repository/AmazonRootCA1.pem
      dest: /home/hydro/root-CA.crt
  - name: Link github webhook receiver systemd service file
    ansible.builtin.file:
      src: /home/hydro/github-webhook-receiver-service/github-webhook-receiver.service
      dest: /etc/systemd/system/github-webhook-receiver.service
      owner: root
      group: root
      state: link
  - name: Enable github webhook receiver service
    ansible.builtin.systemd:
      name: github-webhook-receiver.service
      enabled: yes
  - name: Restart github webhook receiver service and esure config is reloaded
    ansible.builtin.systemd:
      state: restarted
      daemon_reload: yes
      name: github-webhook-receiver.service
      #  - name: Copy github webhook receiver systemd service file
      #    copy:
      #      src: github-webhook-receiver-service/github-webhook-receiver.service
      #      dest: /etc/systemd/system/
      #      owner: hydro
      #      group: hydro


